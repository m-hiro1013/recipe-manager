# =====================================
# 🏛️ ARCHITECTURE.yaml
# =====================================
#
# 【このファイルの役割】
# 実装済み機能の仕様書。プロジェクトの「何ができるか」を記録する静的なドキュメント。
# 完成した機能の仕様・設計を保存し、システム全体の理解に使用する。
#
# 【このファイルに書くこと】
# - プロジェクトの目標・対象ユーザー・成功基準
# - 実装済み機能（status: done）の一覧と仕様
# - 各機能の詳細説明・設計意図
#
# 【このファイルに書かないこと】
# - 実装中・計画中の機能 → WORKFLOW.yaml
# - 決定事項・保留事項 → WORKFLOW.yaml
# - 現在の進捗・次のタスク → WORKFLOW.yaml
# - ファイル構成 → WORKFLOW.yaml
# - 注意点・ハマったこと → WORKFLOW.yaml
# - AIの振る舞いやルール → SYSTEM_PROMPT.yaml
# - 技術スタック・環境情報 → PROJECT_SPECIFIC.yaml
# - テーブル定義・カラム情報 → DATABASE.md
#
# 【このファイルを更新するタイミング】
# - 機能の実装が完了したとき → WORKFLOW.yamlからこちらに移動
# - 完成した機能の仕様を詳細化するとき
#
# 【重要】
# ⚠️ このファイルは基本的に追記のみ（既存内容の削除・変更は慎重に）
# ⚠️ 実装中の機能はWORKFLOW.yamlで管理し、完了後にこちらに移動
#
# =====================================

architecture:
  version: "1.1"
  last_updated: "2026-01-04"

  # =====================================
  # 1. プロジェクト概要
  # =====================================
  project:
    goal:
      primary: "飲食店のレシピ管理と原価計算を効率化"
      target_user: "飲食店の管理者・シェフ・スタッフ"
      success_criteria:
        - "仕入れ商品をCSVからインポートできる"
        - "アイテム（部品化した商品）を登録できる"
        - "仕込み品を登録できる"
        - "商品（最終メニュー）を登録できる"
        - "原価が自動計算される"
        - "複数業態に対応できる"
        - "コースを作成できる"
        - "AIがレシピ資料から情報を読み取り、登録をサポートできる"

  # =====================================
  # 2. 実装済み機能一覧
  # =====================================
  completed_features:

    # ---------------------------------
    # フェーズ1: 基本機能
    # ---------------------------------
    phase1:
      name: "基本機能"
      status: "done"
      features:
        - id: "F001"
          name: "CSVインポート機能"
          description: "インフォマートCSVから仕入れ商品データを一括インポート"
          page: "/import.html"

        - id: "F002"
          name: "仕入れ商品一覧画面"
          description: "インポートした仕入れ商品を業者別に一覧表示"
          page: "/index.html"

        - id: "F003"
          name: "使用商品フラグ機能"
          description: "仕入れ商品ごとに使用/未使用を切り替え"

        - id: "F004"
          name: "業者単位の一括ON/OFF"
          description: "業者に属する全商品の使用フラグを一括切り替え"

        - id: "F005"
          name: "業者の非表示機能"
          description: "使わない業者を一覧から非表示にできる"

        - id: "F006"
          name: "アイテム登録機能"
          description: "仕入れ商品を部品化してアイテムとして登録"
          page: "/items.html"
          details:
            - "仕入れ商品から変換（歩留まり設定）"
            - "ジャンル分類"
            - "読み仮名（五十音順ソート用）"
            - "要確認フラグ"

        - id: "F007"
          name: "仕込み品登録機能"
          description: "アイテム・他の仕込み品を材料として仕込み品を作成"
          page: "/preparations.html"
          details:
            - "材料は複数選択可能"
            - "分量・単位を設定"
            - "仕上がり量を設定"
            - "セクション分類"
            - "要確認フラグ"

        - id: "F008"
          name: "商品登録機能"
          description: "アイテム・仕込み品を材料として最終メニューを作成"
          page: "/dishes.html"
          details:
            - "仕上がりは常に1単位"
            - "売価設定（税抜）"
            - "原価率自動計算"
            - "セクション分類"

        - id: "F009"
          name: "原価自動計算"
          description: "材料の原価から自動的に上位の原価を計算"
          details:
            - "アイテム: 仕入れ商品単価 ÷ 歩留まり"
            - "仕込み品: 材料原価の合計 ÷ 仕上がり量"
            - "商品: 材料原価の合計"
            - "再帰計算対応（仕込み品が仕込み品を材料にするケース）"
            - "循環参照検出"

        - id: "F010"
          name: "マスタ管理機能"
          description: "ジャンル・セクション・単位・業態のマスタ管理"
          page: "/master.html"

    # ---------------------------------
    # フェーズ2: 拡張機能
    # ---------------------------------
    phase2:
      name: "拡張機能"
      status: "done"
      features:
        - id: "F011"
          name: "正規化対応"
          description: "cost/unit_cost列を削除し、表示時に計算する方式に変更"
          reason: "データ整合性を常に担保するため"

        - id: "F012"
          name: "業態展開"
          description: "複数業態に対応、業態ごとにデータを分離"
          details:
            - "仕入れ商品は全業態共通"
            - "アイテム・仕込み品・商品・コースは業態ごと"
            - "サイドメニューのセレクタで業態切り替え"

        - id: "F013"
          name: "売価・原価率追加"
          description: "商品に売価を設定し、原価率を自動計算"
          details:
            - "売価は税抜きで入力"
            - "原価率 = 原価 ÷ 売価 × 100"

        - id: "F014"
          name: "コース機能"
          description: "商品を組み合わせてコースを作成"
          page: "/courses.html"
          details:
            - "コースの中身は商品のみ"
            - "ポーション機能（0.25, 0.5, 1など）"
            - "売価は税込で入力、原価率は税抜換算"
            - "実施中/未実施で分けて金額順表示"
            - "アコーディオン展開で内容確認"

        - id: "F015"
          name: "メニューブック"
          description: "商品一覧の閲覧特化ページ"
          page: "/menubook.html"
          details:
            - "アコーディオンで無限階層展開"
            - "材料名40%固定幅、分量・原価左寄せ"
            - "同階層は排他（1つだけ開く）"

        - id: "F016"
          name: "レシピブック"
          description: "仕込み品一覧の閲覧特化ページ"
          page: "/recipebook.html"
          details:
            - "アコーディオンで無限階層展開"
            - "メニューブックと同じUI/UX"

        - id: "F017"
          name: "要確認フラグ機能"
          description: "アイテム・仕込み品に要確認フラグを設定"
          details:
            - "⚠️マークで表示（編集ページのみ）"
            - "下から上に伝播（材料に要確認があれば上位も表示）"

        - id: "F018"
          name: "リファクタリング（utils.js共通化）"
          description: "重複コードを共通モジュールに集約"
          details:
            - "fetchAllWithPaging: ページング取得"
            - "withBusinessTypeFilter: 業態フィルタ"
            - "IngredientModalManager: 材料選択モーダル"
            - "QuickItemModalManager: クイックアイテム作成"
            - "renderIngredientList: 材料リスト表示"

        - id: "F019"
          name: "メニューブック・レシピブック分量表示改善"
          description: "材料名40%固定幅、分量・原価左寄せ、縦列揃え、ボーダー追加"

        - id: "F020"
          name: "コース一覧アコーディオン化"
          description: "カードクリックで商品展開、複数同時オープンOK"

        - id: "F021"
          name: "仕入れ商品・業者設定の業態別管理"
          description: "使用フラグ・非表示フラグを業態ごとに管理"
          details:
            - "product_business_typesテーブル追加"
            - "supplier_business_typesテーブル追加"
            - "CSVインポート時・業態追加時に中間テーブルレコードを自動作成"

    # ---------------------------------
    # フェーズ3: AIサポート機能
    # ---------------------------------
    phase3:
      name: "AIサポート機能"
      status: "done"
      features:
        - id: "F022"
          name: "AIサポート機能"
          description: "レシピ資料（画像/PDF）からAIが情報を読み取り、仕込み品/商品の登録をサポート"
          page: "/ai-support.html"
          details:
            supported_formats: ["画像", "PDF"]
            pending_formats: ["PPT", "Excel"]
            ai_api: "Gemini 2.5 Flash"
            backend: "Supabase Edge Functions"
            edge_functions:
              - "ai-read-recipe: レシピ読み取り"
              - "ai-check-duplicates: 類似判定"
              - "ai-search-keywords: キーワード生成"
            steps:
              - step: 1
                name: "ファイルアップロード"
                features: ["画像/PDFアップロード", "セッション履歴一覧表示"]
              - step: 2
                name: "レシピ選択"
                features: ["AIが読み取ったレシピ一覧", "類似警告⚠️表示", "🗑️削除機能"]
              - step: 3
                name: "種別選択 + 基本情報入力"
                features: ["仕込み品/商品の選択", "名前・読み仮名・セクション入力", "AIが初期値セット"]
              - step: 4
                name: "材料リスト確認"
                features: ["AIが読み取った材料名を確認・修正"]
              - step: 5
                name: "材料の紐付け"
                features: ["🤖AIで探す", "🔍自分で探す", "クイックアイテム作成", "仕入れ商品なしで作成"]
              - step: 6
                name: "分量・単位の確認"
                features: ["全材料の分量・単位をリスト表示", "仕上がり量入力（仕込み品のみ）"]
              - step: 7
                name: "登録完了"
                features: ["DB登録", "続けて追加 or 終了の選択"]

        - id: "F023"
          name: "セッション自動保存・復元"
          description: "AIサポートの作業状態をDBに自動保存し、ページリロード後も続きから再開"
          details:
            - "ai_support_sessionsテーブル追加"
            - "ステップ移動時に自動保存"
            - "業態ごとに10件まで保存、自動削除"
            - "履歴一覧UI（STEP1下部）"
            - "手動削除機能（🗑️ボタン）"

        - id: "F024"
          name: "AI検索カテゴリ見出し改善"
          description: "AI検索結果のカテゴリ見出しを目立たせる"
          details:
            - "アイテム=青、仕込み品=オレンジ、仕入れ商品=緑"
            - "0件でも見出しを表示（該当なしと表示）"
            - "モーダル開くたびにスクロールトップ"

        - id: "F025"
          name: "「自分で探す」改善"
          description: "検索窓に材料名をデフォルトセット、クイックアイテム初期値改善"
          details:
            - "検索窓に材料名セット+自動検索"
            - "クイックアイテム作成時：アイテム名=材料名、読み仮名=AI生成値"

        - id: "F026"
          name: "仕入れ商品なしアイテム（手動単価）"
          description: "仕入れ商品に紐付かないアイテムを作成可能"
          details:
            - "manual_price=true フラグで管理"
            - "🔁マークで表示（編集ページのみ）"
            - "総量・単位・仕入れ金額から単位原価を自動計算"
            - "「仕入れ商品なしで作成」ボタン（仕入れ商品タブ内）"

        - id: "F027"
          name: "モーダル共通化リファクタリング"
          description: "各ページのモーダルをmodalManagers.jsに集約"
          details:
            - "utils.js と modalManagers.js にファイル分割"
            - "IngredientModalManager: 材料選択モーダル（HTML動的生成）"
            - "QuickItemModalManager: クイックアイテム作成モーダル（HTML動的生成）"
            - "preparations.html, dishes.html からモーダルHTML削除"
            - "preparations.js, dishes.js, ai-support.js で共通利用"